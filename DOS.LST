                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.21.0, LST:Full:4
                                ;   似非DOS
                                
       0005                     SYSTEM  EQU 00005H
       000C                     RDSLT   EQU 0000CH
       001C                     CALSLT  EQU 0001CH
       0024                     ENASLT  EQU 00024H
       005F                     CHGMOD  EQU 0005FH
       006C                     INITXT  EQU 0006CH
       0078                     SETTXT  EQU 00078H
       005C                     FCB1    EQU 0005CH
       0080                     DTA1    EQU 00080H
       F307                     FCB11   EQU 0F307H
       F37D                     BDOS    EQU 0F37DH
       F3AE                     LINL40  EQU 0F3AEH
       F41F                     KBUF    EQU 0F41FH; 318
       F55E                     BUF EQU 0F55EH; 258
       F662                     DIMFLG  EQU 0F662H
       F663                     VALTYP  EQU 0F663H
       F672                     MEMSIZ  EQU 0F672H
       F6A7                     TEMP    EQU 0F6A7H
       F6AF                     SAVTXT  EQU 0F6AFH
       F6B1                     SAVSTK  EQU 0F6B1H
       F7C4                     TRCFLG  EQU 0F7C4H
       F92A                     CLOC    EQU 0F92AH
       F92C                     CMASK   EQU 0F92CH
       F92D                     MINDEL  EQU 0F92DH
       F92F                     MAXDEL  EQU 0F92FH
       FAF8                     EXBRSA  EQU 0FAF8H
       FCC1                     EXPTBL  EQU 0FCC1H
       FFCA                     EXTBIOS EQU 0FFCAH
       0402                     MAPPER  EQU 00402H
                                
       F92C                     SAVE_C  EQU CMASK
       F662                     DE_MEM_SIZE EQU DIMFLG
       F663                     SAVE_A  EQU VALTYP
       F92A                     SAVE_DE EQU CLOC
       F92D                     SAVE_IX EQU MINDEL
       F92F                     SAVE_HL EQU MAXDEL
       F6A7                     EXTSP   EQU TEMP
       F6AF                     DEFAB   EQU SAVTXT
       F55E                     ALT_MEM EQU BUF
       F59E                     ALT_MEM2    EQU ALT_MEM+64
       F5DE                     ALT_MEM3    EQU ALT_MEM2+64
                                
000000 0100                         ORG 0100H
000000 0100 CD6BF3          17      CALL    0F36BH      ;ページ1をメインRAMに切り替える
000003 0103 3EC3             7      LD  A,0C3H      ;JP
000005 0105 320000          13      LD  (0),A       ;WBOOT
000008 0108 320500          13      LD  (SYSTEM),A
00000B 010B AF               4      XOR A
00000C 010C 32C4F7          13      LD  (TRCFLG),A
                                
00000F 010F 0E6F             7      LD  C,06FH      ;_DOSVER MSX-DOS のバージョン番号の獲得
000011 0111 CD7DF3          17      CALL    BDOS
000014 0114 78               4      LD  A,B
000015 0115 FE02             7      CP  2
000017 0117 9F               4      SBC A,A
000018 0118 32C402          13      LD  (ISDOS1),A
00001B 011B 3816            12      JR  C,DOS1R
00001D 011D 214702          10      LD  HL,N_SHELL  ;DOS2の場合はCOMMAND.COMの読み込みに
000020 0120 118A04          10      LD  DE,AT_COMMAND1+1    ;ファイルハンドルを用いるものに差し替え
000023 0123 010600          10      LD  BC,6        ;階層ディレクトリに対応の為
000026 0126 EDB0                    LDIR
000028 0128 214505          10      LD  HL,AT_DOS2RELOAD
00002B 012B 11DB04          10      LD  DE,AT_DOS1RELOAD
00002E 012E 013000          10      LD  BC,DOS2RELOAD_-DOS2RELOAD
000031 0131 EDB0                    LDIR
       0133                     DOS1R:
000033 0133 2A72F6          16      LD  HL,(MEMSIZ)
000036 0136 2E00             7      LD  L,0
000038 0138 22A7F6          16      LD  (EXTSP),HL
00003B 013B 2E03             7      LD  L,3
00003D 013D 25               4      DEC H
00003E 013E 220100          16      LD  (1),HL      ;WBOOT
000041 0141 2C               4      INC L
000042 0142 25               4      DEC H
000043 0143 25               4      DEC H
000044 0144 7C               4      LD  A,H
000045 0145 F9               6      LD  SP,HL
000046 0146 EB               4      EX  DE,HL
000047 0147 21C502          10      LD  HL,REAL
00004A 014A 018002          10      LD  BC,MAIN_END-MAIN
00004D 014D EDB0                    LDIR
                                                ;リロケータブル
00004F 014F 67               4      LD  H,A     ;H:+0/A:+0
000050 0150 2E08             7      LD  L,BDOS0_SWC
000052 0152 F5              11      PUSH    AF
000053 0153 86               7      ADD A,(HL)
000054 0154 77               7      LD  (HL),A
000055 0155 F1              10      POP AF
000056 0156 2E2D             7      LD  L,SYS09_SWC
000058 0158 F5              11      PUSH    AF
000059 0159 86               7      ADD A,(HL)
00005A 015A 77               7      LD  (HL),A
00005B 015B F1              10      POP AF
00005C 015C 24               4      INC H       ;H:+1
00005D 015D 24               4      INC H       ;H:+2
00005E 015E 2E02             7      LD  L,2
000060 0160 F5              11      PUSH    AF
000061 0161 86               7      ADD A,(HL)
000062 0162 77               7      LD  (HL),A
000063 0163 F1              10      POP AF
000064 0164 2E05             7      LD  L,WBOOT+2-BOOT
000066 0166 F5              11      PUSH    AF
000067 0167 86               7      ADD A,(HL)
000068 0168 77               7      LD  (HL),A
000069 0169 F1              10      POP AF
00006A 016A 2E60             7      LD  L,SHOW_ERROR+2-BOOT
00006C 016C F5              11      PUSH    AF
00006D 016D 86               7      ADD A,(HL)
00006E 016E 77               7      LD  (HL),A
00006F 016F F1              10      POP AF
000070 0170 2E08             7      LD  L,CONST_+2-BOOT
000072 0172 F5              11      PUSH    AF
000073 0173 86               7      ADD A,(HL)
000074 0174 77               7      LD  (HL),A
000075 0175 F1              10      POP AF
000076 0176 2E0B             7      LD  L,CONIN+2-BOOT
000078 0178 F5              11      PUSH    AF
000079 0179 86               7      ADD A,(HL)
00007A 017A 77               7      LD  (HL),A
00007B 017B F1              10      POP AF
00007C 017C 2E0E             7      LD  L,CONOUT+2-BOOT
00007E 017E F5              11      PUSH    AF
00007F 017F 86               7      ADD A,(HL)
000080 0180 77               7      LD  (HL),A
000081 0181 F1              10      POP AF
000082 0182 2E19             7      LD  L,FCBPAT+2-BOOT
000084 0184 F5              11      PUSH    AF
000085 0185 86               7      ADD A,(HL)
000086 0186 77               7      LD  (HL),A
000087 0187 F1              10      POP AF
000088 0188 25               4      DEC H       ;H:+1
000089 0189 E5              11      PUSH    HL
00008A 018A 25               4      DEC H       ;H:+0
00008B 018B 2E06             7      LD  L,BDOS0
00008D 018D 220600          16      LD  (SYSTEM+1),HL
000090 0190 0E19             7      LD  C,19H       ;(BDOS)_CURDRV カレントドライブ番号の獲得
000092 0192 CD7DF3          17      CALL    BDOS
000095 0195 3C               4      INC A
000096 0196 E1              10      POP HL      ;H:+1
000097 0197 2EC8             7      LD  L,FCBCMD-BOOT
000099 0199 77               7      LD  (HL),A
00009A 019A C640             7      ADD A,040H
00009C 019C 324D02          13      LD  (V_SHELL),A
                                
00009F 019F 3E28             7      LD  A,40
0000A1 01A1 32AEF3          13      LD  (LINL40),A
0000A4 01A4 FD2AC1FC        20      LD  IY,(EXPTBL) ;メインROMスロット
0000A8 01A8 DD216C00        14      LD  IX,INITXT
0000AC 01AC CD1C00          17      CALL    CALSLT
0000AF 01AF FD2AC1FC        20      LD  IY,(EXPTBL) ;メインROMスロット
0000B3 01B3 DD217800        14      LD  IX,SETTXT
0000B7 01B7 CD1C00          17      CALL    CALSLT
                                
0000BA 01BA 112602          10      LD  DE,TITLE
0000BD 01BD 0E09             7      LD  C,9
0000BF 01BF CD7DF3          17      CALL    BDOS
0000C2 01C2 3AC402          13      LD  A,(ISDOS1)
0000C5 01C5 87               4      ADD A,A
0000C6 01C6 3843            12      JR  C,DOS1
0000C8 01C8 1E32             7      LD  E,'2'
0000CA 01CA 0E02             7      LD  C,2
0000CC 01CC CD7DF3          17      CALL    BDOS
                                
0000CF 01CF 214702          10      LD  HL,N_SHELL
0000D2 01D2 114D02          10      LD  DE,V_SHELL
0000D5 01D5 0E6C             7      LD  C,06CH      ;_SENV 環境変数のセット
0000D7 01D7 CD7DF3          17      CALL    BDOS
                                
0000DA 01DA 3AC1FC          13      LD  A,(EXPTBL)  ;メインROMスロット
0000DD 01DD 212B00          10      LD  HL,002BH    ;キャラクターセット・日時フォーマット・ビデオ信号の種別
0000E0 01E0 CD0C00          17      CALL    RDSLT
0000E3 01E3 0F               4      RRCA
0000E4 01E4 0F               4      RRCA
0000E5 01E5 0F               4      RRCA
0000E6 01E6 0F               4      RRCA
0000E7 01E7 E603             7      AND 3
0000E9 01E9 3D               4      DEC A
0000EA 01EA 116A02          10      LD  DE,V_DATE1
0000ED 01ED 2809            12      JR  Z,DATEOK
0000EF 01EF 3D               4      DEC A
0000F0 01F0 117302          10      LD  DE,V_DATE2
0000F3 01F3 2803            12      JR  Z,DATEOK
0000F5 01F5 116102          10      LD  DE,V_DATE0
       01F8                     DATEOK:
0000F8 01F8 215C02          10      LD  HL,N_DATE
0000FB 01FB 0E6C             7      LD  C,06CH      ;_SENV 環境変数のセット
0000FD 01FD CD7DF3          17      CALL    BDOS
                                
000100 0200 217C02          10      LD  HL,N_TIME
000103 0203 118102          10      LD  DE,V_TIME
000106 0206 0E6C             7      LD  C,06CH      ;_SENV 環境変数のセット
000108 0208 CD7DF3          17      CALL    BDOS
                                
       020B                     DOS1:
00010B 020B 112A02          10      LD  DE,TITLE2
00010E 020E 0E09             7      LD  C,9
000110 0210 CD7DF3          17      CALL    BDOS
000113 0213 010900          10      LD  BC,9
000116 0216 213E02          10      LD  HL,AUTOEXEC
000119 0219 118100          10      LD  DE,DTA1+1
00011C 021C EDB0                    LDIR
00011E 021E 3E09             7      LD  A,9
000120 0220 2A0100          16      LD  HL,(1)
000123 0223 2E10             7      LD  L,CBOOT & $FF
       0225                     JP_HL:
000125 0225 E9               4      JP  (HL)
       0226                     TITLE:
000126 0226 444F5324                DB  "DOS$"
       022A                     TITLE2:
00012A 022A 20666F72204D5358        DB  " for MSX v0.19 Gaku$"
            2076302E31392047    
            616B7524            
       023E                     AUTOEXEC:
00013E 023E 4155544F45584543        DB  "AUTOEXEC",0
            00                  
       0247                     N_SHELL:
000147 0247 5348454C4C00            DB  "SHELL",0
       024D                     V_SHELL:
00014D 024D 413A5C434F4D4D41        DB  "A:\\COMMAND.COM",0
            4E442E434F4D00      
       025C                     N_DATE:
00015C 025C 4441544500              DB  "DATE",0
       0261                     V_DATE0:
000161 0261 79792D6D6D2D6464        DB  "yy-mm-dd",0
            00                  
       026A                     V_DATE1:
00016A 026A 6D6D2D64642D7979        DB  "mm-dd-yy",0
            00                  
       0273                     V_DATE2:
000173 0273 64642D6D6D2D7979        DB  "dd-mm-yy",0
            00                  
       027C                     N_TIME:
00017C 027C 54494D4500              DB  "TIME",0
       0281                     V_TIME:
000181 0281 323400                  DB  "24",0
       0284                     Z_TIME:
000184 0284                         DS  64
       02C4                     ISDOS1:
0001C4 02C4 00                      DB  0
       02C5                     REAL:
0001C5 0004                         ORG 4,REAL-0100H
       0004                     MAIN:
0001C5 0004 0000                    DW  0
       0006                     BDOS0:
0001C7 0006 C31500          10      JP  BDOS1
       0008                     BDOS0_SWC   EQU $-1
       0009                     TERM:
0001CA 0009 78               4      LD  A,B
0001CB 000A 32C4F7          13      LD  (TRCFLG),A
0001CE 000D 210000          10      LD  HL,0
0001D1 0010 E5              11      PUSH    HL
0001D2 0011 2AAFF6          16      LD  HL,(DEFAB)
0001D5 0014 E9               4      JP  (HL)
       0015                     BDOS1:
0001D6 0015 3263F6          13      LD  (SAVE_A),A
0001D9 0018 79               4      LD  A,C
0001DA 0019 B7               4      OR  A
0001DB 001A CA0000          10      JP  Z,0
0001DE 001D ED73B1F6        20      LD  (SAVSTK),SP
0001E2 0021 FE62             7      CP  062H        ;_TERM エラーコードを返して終了
0001E4 0023 28E4            12      JR  Z,TERM
0001E6 0025 ED7BA7F6        20      LD  SP,(EXTSP)
0001EA 0029 FE09             7      CP  9       ;_STROUT 文字列出力
0001EC 002B CAB801          10      JP  Z,_SYS09
       002D                     SYS09_SWC   EQU     $-1
0001EF 002E FE63             7      CP  063H        ;_DEFAB アボート終了ルーチンの定義
0001F1 0030 2004            12      JR  NZ,BDOS2
0001F3 0032 ED53AFF6        20      LD  (DEFAB),DE
       0036                     BDOS2:
0001F7 0036 322CF9          13      LD  (SAVE_C),A
0001FA 0039 FE0F             7      CP  00FH        ;_FOPEN ファイルオープン
0001FC 003B 3859            12      JR  C,SAVEFCB0
0001FE 003D FE12             7      CP  012H        ;_SNEXT ファイル検索 続き
000200 003F 2004            12      JR  NZ,NOBD12
000202 0041 ED5B07F3        20      LD  DE,(FCB11)
       0045                     NOBD12:
000206 0045 FE18             7      CP  018H        ;_LOGIN ログインベクトルの獲得
000208 0047 383A            12      JR  C,SAVEFCB36
00020A 0049 FE21             7      CP  021H        ;_RDRND ランダム読み出し
00020C 004B 3849            12      JR  C,SAVEFCB0
00020E 004D FE29             7      CP  028H+1      ;_WRZER ゼロ書き込みを伴うランダム書き込み+1
000210 004F 3832            12      JR  C,SAVEFCB36
000212 0051 FE31             7      CP  031H        ;_DPARM ディスクパラメータの獲得
000214 0053 282E            12      JR  Z,SAVEFCB36
000216 0055 FE40             7      CP  040H        ;_FFIRST 最初のエントリ検索
000218 0057 282A            12      JR  Z,SAVE_PATH
00021A 0059 FE42             7      CP  042H        ;_FNEW 新しいエントリの検索
00021C 005B 2826            12      JR  Z,SAVE_PATH
00021E 005D FE43             7      CP  043H        ;_OPEN ファイルハンドルのオープン
000220 005F 2822            12      JR  Z,SAVE_PATH
000222 0061 FE44             7      CP  044H        ;_CREATE ファイルハンドルの作成
000224 0063 281E            12      JR  Z,SAVE_PATH
000226 0065 FE4C             7      CP  04CH        ;_HTEST ファイルハンドルの検査
000228 0067 281A            12      JR  Z,SAVE_PATH
00022A 0069 FE4D             7      CP  04DH        ;_DELETE ファイル、サブディレクトリの削除
00022C 006B 3829            12      JR  C,SAVEFCB0
00022E 006D FE52             7      CP  051H+1      ;_FTIME ファイルの日付および時刻の獲得・設定
000230 006F 3812            12      JR  C,SAVE_PATH
000232 0071 FE59             7      CP  059H        ;_GETCD カレントディレクトリの獲得
000234 0073 3821            12      JR  C,SAVEFCB0
000236 0075 FE5D             7      CP  05CH+1      ;_PFILE ファイル名の解析+1
000238 0077 380A            12      JR  C,SAVE_PATH
00023A 0079 FE5E             7      CP  05EH        ;_WPATH パス文字列全体の獲得
00023C 007B 2806            12      JR  Z,SAVE_PATH
00023E 007D FE66             7      CP  066H        ;_EXPLAIN エラーコードの説明
000240 007F 2802            12      JR  Z,SAVE_PATH
000242 0081 1813            12      JR  SAVEFCB0
       0083                     SAVEFCB36:
       0083                     SAVE_PATH:
000244 0083 7A               4      LD  A,D
000245 0084 FE3F             7      CP  03FH        ;ページ1にかぶる？
000247 0086 380E            12      JR  C,SAVEFCB0
000249 0088 FE80             7      CP  080H
00024B 008A 300A            12      JR  NC,SAVEFCB0
00024D 008C 3E24             7      LD  A,36
00024F 008E CB71             8      BIT 6,C     ;DOS2のファンクションコール？
000251 0090 2805            12      JR  Z,SAVEFCB1
000253 0092 3E40             7      LD  A,64        ;DOS2CALLは64バイト設定する
000255 0094 1801            12      JR  SAVEFCB1
       0096                     SAVEFCB0:
000257 0096 AF               4      XOR A
       0097                     SAVEFCB1:
000258 0097 3262F6          13      LD  (DE_MEM_SIZE),A
00025B 009A B7               4      OR  A
00025C 009B 2815            12      JR  Z,BDOS3
00025E 009D C5              11      PUSH    BC
00025F 009E E5              11      PUSH    HL
000260 009F ED532AF9        20      LD  (SAVE_DE),DE
000264 00A3 4F               4      LD  C,A
000265 00A4 0600             7      LD  B,0
000267 00A6 215EF5          10      LD  HL,ALT_MEM
00026A 00A9 EB               4      EX  DE,HL
00026B 00AA D5              11      PUSH    DE
00026C 00AB EDB0                    LDIR
00026E 00AD AF               4      XOR A
00026F 00AE 12               7      LD  (DE),A
000270 00AF D1              10      POP DE
000271 00B0 E1              10      POP HL
000272 00B1 C1              10      POP BC
       00B2                     BDOS3:
000273 00B2 AF               4      XOR A
000274 00B3 322EF9          13      LD  (SAVE_IX+1),A
000277 00B6 79               4      LD  A,C
000278 00B7 FE40             7      CP  040H        ;最初のエントリ検索
00027A 00B9 3826            12      JR  C,BDOS3IX   ;次のエントリ検索
00027C 00BB FE43             7      CP  042H+1      ;新しいエントリの検索
00027E 00BD 3022            12      JR  NC,BDOS3IX
000280 00BF DD7C             9      LD  A,IXH
000282 00C1 FE3F             7      CP  03FH        ;ページ1にかぶる？
000284 00C3 381C            12      JR  C,BDOS3IX
000286 00C5 FE80             7      CP  080H        ;
000288 00C7 3018            12      JR  NC,BDOS3IX
00028A 00C9 DD222DF9        20      LD  (SAVE_IX),IX
00028E 00CD C5              11      PUSH    BC
00028F 00CE D5              11      PUSH    DE
000290 00CF E5              11      PUSH    HL
000291 00D0 DDE5            15      PUSH    IX
000293 00D2 E1              10      POP HL
000294 00D3 119EF5          10      LD  DE,ALT_MEM2
000297 00D6 014000          10      LD  BC,64
00029A 00D9 D5              11      PUSH    DE
00029B 00DA EDB0                    LDIR
00029D 00DC DDE1            14      POP IX
00029F 00DE E1              10      POP HL
0002A0 00DF D1              10      POP DE
0002A1 00E0 C1              10      POP BC
       00E1                     BDOS3IX:
0002A2 00E1 AF               4      XOR A
0002A3 00E2 3230F9          13      LD  (SAVE_HL+1),A
0002A6 00E5 79               4      LD  A,C
0002A7 00E6 FE4E             7      CP  4EH     ;_RENAME ファイルあるいはサブディレクトリ名の変更
0002A9 00E8 281C            12      JR  Z,SAVE_HL1
0002AB 00EA FE4F             7      CP  4FH     ;_MOVE ファイルあるいはサブディレクトリの移動
0002AD 00EC 2818            12      JR  Z,SAVE_HL1
0002AF 00EE FE53             7      CP  53H     ;_HRENAME ファイルハンドルの名前の変更
0002B1 00F0 2814            12      JR  Z,SAVE_HL1
0002B3 00F2 FE54             7      CP  54H     ;_HMOVE ファイルハンドルの移動
0002B5 00F4 2810            12      JR  Z,SAVE_HL1
0002B7 00F6 FE5C             7      CP  05CH        ;_PFILE ファイル名の解析
0002B9 00F8 280C            12      JR  Z,SAVE_HL1
0002BB 00FA FE40             7      CP  040H        ;_FFIRST 最初のエントリ検索
0002BD 00FC 2804            12      JR  Z,FIBCHECK
0002BF 00FE FE42             7      CP  042H        ;_FNEW 新しいエントリ検索
0002C1 0100 201F            12      JR  NZ,BDOS3HL
       0102                     FIBCHECK:
0002C3 0102 1A               7      LD  A,(DE)
0002C4 0103 3C               4      INC A       ;DEがFIBならば0FFH
0002C5 0104 201B            12      JR  NZ,BDOS3HL
       0106                     SAVE_HL1:
0002C7 0106 7C               4      LD  A,H
0002C8 0107 FE3F             7      CP  03FH        ;ページ1にかぶる？
0002CA 0109 3816            12      JR  C,BDOS3HL
0002CC 010B FE80             7      CP  080H        ;
0002CE 010D 3012            12      JR  NC,BDOS3HL
0002D0 010F 222FF9          16      LD  (SAVE_HL),HL
0002D3 0112 C5              11      PUSH    BC
0002D4 0113 D5              11      PUSH    DE
0002D5 0114 014000          10      LD  BC,64
0002D8 0117 11DEF5          10      LD  DE,ALT_MEM3
0002DB 011A EDB0                    LDIR
0002DD 011C D1              10      POP DE
0002DE 011D C1              10      POP BC
0002DF 011E 21DEF5          10      LD  HL,ALT_MEM3
       0121                     BDOS3HL:
0002E2 0121 3A63F6          13      LD  A,(SAVE_A)
0002E5 0124 CD7DF3          17      CALL    BDOS
                                
0002E8 0127 F5              11      PUSH    AF
                                
0002E9 0128 3A2EF9          13      LD  A,(SAVE_IX+1)       ;最初のエントリ検索 + 次のエントリ検索
0002EC 012B B7               4      OR  A
0002ED 012C 2815            12      JR  Z,BDOS4IX
0002EF 012E DD2A2DF9        20      LD  IX,(SAVE_IX)
0002F3 0132 C5              11      PUSH    BC
0002F4 0133 D5              11      PUSH    DE
0002F5 0134 E5              11      PUSH    HL
0002F6 0135 DDE5            15      PUSH    IX
0002F8 0137 D1              10      POP DE
0002F9 0138 219EF5          10      LD  HL,ALT_MEM2
0002FC 013B 014000          10      LD  BC,64
0002FF 013E EDB0                    LDIR
000301 0140 E1              10      POP HL
000302 0141 D1              10      POP DE
000303 0142 C1              10      POP BC
       0143                     BDOS4IX:
000304 0143 3A62F6          13      LD  A,(DE_MEM_SIZE)
000307 0146 B7               4      OR  A
000308 0147 2812            12      JR  Z,BDOS4
00030A 0149 C5              11      PUSH    BC
00030B 014A D5              11      PUSH    DE
00030C 014B E5              11      PUSH    HL
00030D 014C 4F               4      LD  C,A
00030E 014D 0600             7      LD  B,0
000310 014F 215EF5          10      LD  HL,ALT_MEM
000313 0152 ED5B2AF9        20      LD  DE,(SAVE_DE)
000317 0156 EDB0                    LDIR
000319 0158 E1              10      POP HL
00031A 0159 D1              10      POP DE
00031B 015A C1              10      POP BC
       015B                     BDOS4:
00031C 015B 3A30F9          13      LD  A,(SAVE_HL+1)
00031F 015E B7               4      OR  A
000320 015F 2812            12      JR  Z,BDOS5
000322 0161 C5              11      PUSH    BC
000323 0162 D5              11      PUSH    DE
000324 0163 E5              11      PUSH    HL
000325 0164 010B00          10      LD  BC,11
000328 0167 21DEF5          10      LD  HL,ALT_MEM3
00032B 016A ED5B2FF9        20      LD  DE,(SAVE_HL)
00032F 016E EDB0                    LDIR
000331 0170 E1              10      POP HL
000332 0171 D1              10      POP DE
000333 0172 C1              10      POP BC
       0173                     BDOS5:
000334 0173 3A2CF9          13      LD  A,(SAVE_C)
000337 0176 FE6F             7      CP  6FH     ;_DOSVER MSX-DOSのバージョン番号の獲得
000339 0178 2002            12      JR  NZ,BDOS7
00033B 017A 59               4      LD  E,C     ;MSXDOS2.SYSのバージョンをカーネルに合わす
00033C 017B 50               4      LD  D,B     ;
       017C                     BDOS7:
00033D 017C FE5B             7      CP  05BH        ;_PARSE パス名の解析
00033F 017E 2804            12      JR  Z,BDOS8
000341 0180 FE5E             7      CP  05EH        ;_WPATH パス文字列全体の獲得
000343 0182 201E            12      JR  NZ,BDOS6
       0184                     BDOS8:
000345 0184 3A62F6          13      LD  A,(DE_MEM_SIZE)
000348 0187 2819            12      JR  Z,BDOS6
00034A 0189 C5              11      PUSH    BC
00034B 018A 015EF5          10      LD  BC,ALT_MEM
00034E 018D ED42            15      SBC HL,BC       ;CF=0のハズ
000350 018F ED4B2AF9        20      LD  BC,(SAVE_DE)
000354 0193 09              11      ADD HL,BC
000355 0194 EB               4      EX  DE,HL
000356 0195 015EF5          10      LD  BC,ALT_MEM
000359 0198 A7               4      AND A       ;念のためにCF=0にする
00035A 0199 ED42            15      SBC HL,BC
00035C 019B ED4B2AF9        20      LD  BC,(SAVE_DE)
000360 019F 09              11      ADD HL,BC
000361 01A0 EB               4      EX  DE,HL
000362 01A1 C1              10      POP BC
       01A2                     BDOS6:
000363 01A2 F1              10      POP AF
       01A3                     S09X1:
000364 01A3 ED7BB1F6        20      LD  SP,(SAVSTK)
000368 01A7 C9              10      RET
                                
       01A8                     CONST1:
000369 01A8 0E0B             7      LD  C,0BH
00036B 01AA C30500          10      JP  SYSTEM
       01AD                     CONIN1:
00036E 01AD 0E07             7      LD  C,7
000370 01AF C30500          10      JP  SYSTEM
       01B2                     CONOUT1:
000373 01B2 59               4      LD  E,C
000374 01B3 0E02             7      LD  C,2
000376 01B5 C30500          10      JP  SYSTEM
                                
       01B8                     _SYS09:     ;_STROUT 文字列出力
000379 01B8 1A               7      LD  A,(DE)
00037A 01B9 13               6      INC DE
00037B 01BA FE24             7      CP  '$'
00037D 01BC 28E5            12      JR  Z,S09X1
00037F 01BE D5              11      PUSH    DE
000380 01BF 0E02             7      LD  C,2
000382 01C1 5F               4      LD  E,A
000383 01C2 CD7DF3          17      CALL    BDOS
000386 01C5 D1              10      POP DE
000387 01C6 18F0            12      JR  _SYS09
                                
       01C8                     FCBCMD:
000389 0489                         ORG $$+0100H    ;$DEPHASE
       0489                     AT_COMMAND1:
000389 01C8                         ORG FCBCMD,AT_COMMAND1-0100H
000389 01C8 00434F4D4D414E44        DB  0,"COMMAND COM",0,0,0,0
            20434F4D00000000    
                                
       01D8                     AT:
000399 01D8                         DS  0200H-37-AT
       01DB                     FCB_BAT:
00039C 01DB                         DS  37          ;バッチファイル用のFCB
                                ;           下位1バイト0になるように
       0200                     BOOT:
0003C1 0200 C30F02          10      JP  WBOOT1
       0203                     WBOOT:
0003C4 0203 C30F02          10      JP  WBOOT1
       0206                     CONST_:         ;(BDOS)コンソール直接入力
0003C7 0206 C3A801          10      JP  CONST1
       0209                     CONIN:
0003CA 0209 C3AD01          10      JP  CONIN1
       020C                     CONOUT:
0003CD 020C C3B201          10      JP  CONOUT1
                                
       020F                     WBOOT1:
0003D0 020F AF               4      XOR A
       0210                     CBOOT:
0003D1 0210 3263F6          13      LD  (SAVE_A),A
0003D4 0213 ED7B0600        20      LD  SP,(SYSTEM+1)
       0217                     RELOAD:
0003D8 0217 21C801          10  FCBPAT: LD  HL,FCBCMD
       021A                     DOS1RELOAD:
       04DB                     AT_DOS1RELOAD   EQU $$+0100H
0003DB 021A 115C00          10      LD  DE,FCB1
0003DE 021D 011000          10      LD  BC,16
0003E1 0220 EDB0                    LDIR
                                
0003E3 0222 115C00          10      LD  DE,FCB1
0003E6 0225 0E0F             7      LD  C,00FH      ;(BDOS)_FOPEN ファイルオープン
0003E8 0227 CD7DF3          17      CALL    BDOS
0003EB 022A B7               4      OR  A
0003EC 022B 2031            12      JR  NZ,SHOW_ERROR
0003EE 022D 210000          10      LD  HL,0
0003F1 0230 227D00          16      LD  (FCB1+33),HL
0003F4 0233 227F00          16      LD  (FCB1+35),HL
0003F7 0236 2C               4      INC L
0003F8 0237 226A00          16      LD  (FCB1+14),HL
                                
0003FB 023A 110001          10      LD  DE,00100H
0003FE 023D 0E1A             7      LD  C,01AH      ;(BDOS)DTAの設定
000400 023F CD7DF3          17      CALL    BDOS
                                
000403 0242 115C00          10      LD  DE,FCB1
000406 0245 2100BF          10      LD  HL,0BF00H
000409 0248 0E27             7      LD  C,027H      ;(BDOS)ランダムブロックリード
00040B 024A CD7DF3          17      CALL    BDOS
       024D                     READOK:
00040E 024D 7C               4      LD  A,H
00040F 024E B5               4      OR  L
000410 024F 3A63F6          13      LD  A,(SAVE_A)
000413 0252 328000          13      LD  (DTA1),A
000416 0255 210000          10      LD  HL,0
000419 0258 22AFF6          16      LD  (DEFAB),HL  ;DEFABの初期化
00041C 025B C20001          10      JP  NZ,0100H
       025E                     SHOW_ERROR:
00041F 025E 116F02          10      LD  DE,ERROR
000422 0261 0E09             7      LD  C,9
000424 0263 CD7DF3          17      CALL    BDOS
000427 0266 0E08             7      LD  C,8
000429 0268 CD7DF3          17      CALL    BDOS
00042C 026B AF               4      XOR A
00042D 026C 24               4      INC H
00042E 026D 18A8            12      JR  RELOAD
                                
       026F                     ERROR:
000430 026F 0D0A496E73657274        DB  00DH,00AH,"Insert System disk$"
            2053797374656D20    
            6469736B24          
                                
       0284                     MAIN_END:
000445 0545                         ORG $$+0100H    ;$DEPHASE
       0545                     AT_DOS2RELOAD:
000445 021A                         ORG DOS1RELOAD,AT_DOS2RELOAD-0100H
       021A                     DOS2RELOAD:
000445 021A 23               6      INC HL      ;HLは"SHELL"のポインタ
000446 021B 115EF5          10      LD  DE,ALT_MEM
000449 021E 0640             7      LD  B,64
00044B 0220 0E6B             7      LD  C,06BH      ;_GENV 環境変数の獲得
00044D 0222 CD7DF3          17      CALL    BDOS
000450 0225 115EF5          10      LD  DE,ALT_MEM
000453 0228 AF               4      XOR A
000454 0229 0E43             7      LD  C,043H      ;_OPEN ファイルハンドルのオープン
000456 022B CD7DF3          17      CALL    BDOS
000459 022E B7               4      OR  A
00045A 022F 202D            12      JR  NZ,SHOW_ERROR
00045C 0231 C5              11      PUSH    BC
00045D 0232 110001          10      LD  DE,00100H
000460 0235 2100BF          10      LD  HL,0BF00H
000463 0238 0E48             7      LD  C,48H       ;_READ ファイルハンドルからの読み出し
000465 023A CD7DF3          17      CALL    BDOS
000468 023D C1              10      POP BC
000469 023E B7               4      OR  A
00046A 023F 201D            12      JR  NZ,SHOW_ERROR
00046C 0241 E5              11      PUSH    HL
00046D 0242 0E45             7      LD  C,45H       ;_CLOSE ファイルハンドルのクローズ
00046F 0244 CD7DF3          17      CALL    BDOS
000472 0247 E1              10      POP HL
000473 0248 1803            12      JR  READOK
       024A                     DOS2RELOAD_:
000475 0575                         ORG $$+0100H    ;$DEPHASE
[EOF:DOS.ASM:UTF_8]
