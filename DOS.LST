                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.21.0, LST:Full:4
                                ;   似非DOS
                                
                                    INCLUDE "DEF.ASM"
                                ;
                                ;   似非DOS
                                ;
       0024                     VER_BCD EQU 00024H
                                
       0005                     SYSTEM  EQU 00005H
       005C                     FCB1    EQU 0005CH
       006C                     FCB2    EQU 0006CH
       0080                     DTA1    EQU 00080H
                                
       000C                     RDSLT   EQU 0000CH
       001C                     CALSLT  EQU 0001CH
       006C                     INITXT  EQU 0006CH
       006F                     INIT32  EQU 0006FH
       0078                     SETTXT  EQU 00078H
       007B                     SETT32  EQU 0007BH
       0147                     FORMAT  EQU 00147H
                                
       0402                     MAPPER  EQU 00402H
                                
       F307                     FCB11   EQU 0F307H
       F37D                     BDOS    EQU 0F37DH
       F3AF                     LINL32  EQU 0F3AFH
       F3AE                     LINL40  EQU 0F3AEH
       F3B0                     LINLEN  EQU 0F3B0H
                                
       F41F                     KBUF    EQU 0F41FH; 318
       F55E                     BUF EQU 0F55EH; 258
                                
       F662                     DIMFLG  EQU 0F662H
       F663                     VALTYP  EQU 0F663H
       F672                     MEMSIZ  EQU 0F672H
       F6A7                     TEMP    EQU 0F6A7H
       F6AF                     SAVTXT  EQU 0F6AFH
       F6B1                     SAVSTK  EQU 0F6B1H
       F6B5                     DOT EQU 0F6B5H
       F6B9                     ONELIN  EQU 0F6B9H
                                
       F7C4                     TRCFLG  EQU 0F7C4H
                                
       FAF8                     EXBRSA  EQU 0FAF8H
                                
       FC9B                     INTFLG  EQU 0FC9BH
       FCC1                     EXPTBL  EQU 0FCC1H
       FFCA                     EXTBIOS EQU 0FFCAH
[EOF:DEF.ASM:UTF_8]
                                
       F662                     DE_MEM_SIZE EQU DIMFLG
       F663                     SAVE_A  EQU VALTYP
       F6A7                     EXTSP   EQU TEMP
       F6AF                     DEFAB   EQU SAVTXT
       F6B5                     _DTA    EQU DOT
                                
       F41F                     ALT_MEM EQU KBUF
       F45F                     ALT_MEM2    EQU ALT_MEM+64
       F49F                     ALT_MEM3    EQU ALT_MEM2+64
       F4DF                     SAVE_C  EQU ALT_MEM3+64
       F4E0                     SAVE_DE EQU SAVE_C+1
       F4E2                     SAVE_IX EQU SAVE_DE+2
       F4E4                     SAVE_HL EQU SAVE_IX+2
                                
000000 0100                         ORG 00100H
000000 0100 CD6BF3          17      CALL    0F36BH      ;ページ1をメインRAMに切り替える
000003 0103 3EC3             7      LD  A,0C3H      ;JP
000005 0105 320000          13      LD  (0),A       ;WBOOT
000008 0108 320500          13      LD  (SYSTEM),A
00000B 010B AF               4      XOR A
00000C 010C 32C4F7          13      LD  (TRCFLG),A
                                
00000F 010F 213412          10      LD  HL,01234H       ;NEXTOR チェックの為
000012 0112 11CDAB          10      LD  DE,0ABCDH
000015 0115 DD210000        14      LD  IX,0
000019 0119 016F5A          10      LD  BC,05A6FH       ;_DOSVER MSX-DOS のバージョン番号の獲得
00001C 011C CD7DF3          17      CALL    BDOS
                                
00001F 011F DD7C             9      LD  A,IXH
000021 0121 32E703          13      LD  (OS_EXT),A
000024 0124 78               4      LD  A,B
000025 0125 FE02             7      CP  2
000027 0127 9F               4      SBC A,A
000028 0128 32E603          13      LD  (ISDOS1),A
00002B 012B 3818            12      JR  C,DOS1R
00002D 012D 216903          10      LD  HL,N_SHELL  ;DOS2の場合はCOMMAND.COMの読み込みに
000030 0130 116206          10      LD  DE,AT_COMMAND1+1    ;ファイルハンドルを用いるものに差し替え
000033 0133 010600          10      LD  BC,6        ;階層ディレクトリに対応の為
000036 0136 EDB0                    LDIR
000038 0138 216A07          10      LD  HL,AT_DOS2RELOAD
00003B 013B 110007          10      LD  DE,AT_DOS1RELOAD
00003E 013E 013000          10      LD  BC,DOS2RELOAD_-DOS2RELOAD
000041 0141 EDB0                    LDIR
000043 0143 180C            12      JR  DOS2R
       0145                     DOS1R:
000045 0145 21918A          10      LD  HL,08A91H   ;Tablacus Disk ROM Lite判別
000048 0148 AF               4      XOR A
000049 0149 ED52            15      SBC HL,DE
00004B 014B 2001            12      JR  NZ,DOS1R1
00004D 014D 3D               4      DEC A
       014E                     DOS1R1:
00004E 014E 32E703          13      LD  (OS_EXT),A
       0151                     DOS2R:
000051 0151 2A72F6          16      LD  HL,(MEMSIZ)
000054 0154 2E00             7      LD  L,0
000056 0156 22A7F6          16      LD  (EXTSP),HL
000059 0159 2E03             7      LD  L,3
00005B 015B 25               4      DEC H
00005C 015C 220100          16      LD  (1),HL      ;WBOOT
00005F 015F 25               4      DEC H
000060 0160 25               4      DEC H
000061 0161 25               4      DEC H
000062 0162 2E00             7      LD  L,0
000064 0164 22E803          16      LD  (BASE),HL
000067 0167 2E04             7      LD  L,4
000069 0169 F9               6      LD  SP,HL
00006A 016A EB               4      EX  DE,HL
00006B 016B 21EA03          10      LD  HL,REAL
00006E 016E 018003          10      LD  BC,MAIN_END-MAIN
000071 0171 EDB0                    LDIR
                                                ;リロケータブル
000073 0173 2AE803          16      LD  HL,(BASE)
000076 0176 7C               4      LD  A,H
000077 0177 010800          10      LD  BC,BDOS0_SWC
00007A 017A 09              11      ADD HL,BC
00007B 017B 86               7      ADD A,(HL)
00007C 017C 77               7      LD  (HL),A
                                
00007D 017D 2AE803          16      LD  HL,(BASE)
000080 0180 7C               4      LD  A,H
000081 0181 013500          10      LD  BC,SYS09_SWC
000084 0184 09              11      ADD HL,BC
000085 0185 86               7      ADD A,(HL)
000086 0186 77               7      LD  (HL),A
                                
000087 0187 2AE803          16      LD  HL,(BASE)
00008A 018A 7C               4      LD  A,H
00008B 018B 010203          10      LD  BC,BOOT+2
00008E 018E 09              11      ADD HL,BC
00008F 018F 86               7      ADD A,(HL)
000090 0190 77               7      LD  (HL),A
                                
000091 0191 2AE803          16      LD  HL,(BASE)
000094 0194 7C               4      LD  A,H
000095 0195 010503          10      LD  BC,WBOOT+2
000098 0198 09              11      ADD HL,BC
000099 0199 86               7      ADD A,(HL)
00009A 019A 77               7      LD  (HL),A
                                
00009B 019B 2AE803          16      LD  HL,(BASE)
00009E 019E 7C               4      LD  A,H
00009F 019F 013601          10      LD  BC,RDABS_SWC
0000A2 01A2 09              11      ADD HL,BC
0000A3 01A3 86               7      ADD A,(HL)
0000A4 01A4 77               7      LD  (HL),A
                                
0000A5 01A5 2AE803          16      LD  HL,(BASE)
0000A8 01A8 7C               4      LD  A,H
0000A9 01A9 013B01          10      LD  BC,WRABS_SWC
0000AC 01AC 09              11      ADD HL,BC
0000AD 01AD 86               7      ADD A,(HL)
0000AE 01AE 77               7      LD  (HL),A
                                
0000AF 01AF 2AE803          16      LD  HL,(BASE)
0000B2 01B2 7C               4      LD  A,H
0000B3 01B3 01FA01          10      LD  BC,BDOS_EXEC_SWC1
0000B6 01B6 09              11      ADD HL,BC
0000B7 01B7 86               7      ADD A,(HL)
0000B8 01B8 77               7      LD  (HL),A
                                
0000B9 01B9 2AE803          16      LD  HL,(BASE)
0000BC 01BC 7C               4      LD  A,H
0000BD 01BD 014602          10      LD  BC,BDOS_EXEC_SWC2
0000C0 01C0 09              11      ADD HL,BC
0000C1 01C1 86               7      ADD A,(HL)
0000C2 01C2 77               7      LD  (HL),A
                                
0000C3 01C3 2AE803          16      LD  HL,(BASE)
0000C6 01C6 7C               4      LD  A,H
0000C7 01C7 01FF01          10      LD  BC,BUF512_SWC1
0000CA 01CA 09              11      ADD HL,BC
0000CB 01CB 86               7      ADD A,(HL)
0000CC 01CC 77               7      LD  (HL),A
                                
0000CD 01CD 2AE803          16      LD  HL,(BASE)
0000D0 01D0 7C               4      LD  A,H
0000D1 01D1 011D02          10      LD  BC,BUF512_SWC2
0000D4 01D4 09              11      ADD HL,BC
0000D5 01D5 86               7      ADD A,(HL)
0000D6 01D6 77               7      LD  (HL),A
                                
0000D7 01D7 2AE803          16      LD  HL,(BASE)
0000DA 01DA 7C               4      LD  A,H
0000DB 01DB 014B02          10      LD  BC,BUF512_SWC3
0000DE 01DE 09              11      ADD HL,BC
0000DF 01DF 86               7      ADD A,(HL)
0000E0 01E0 77               7      LD  (HL),A
                                
0000E1 01E1 2AE803          16      LD  HL,(BASE)
0000E4 01E4 7C               4      LD  A,H
0000E5 01E5 015D02          10      LD  BC,BUF512_SWC4
0000E8 01E8 09              11      ADD HL,BC
0000E9 01E9 86               7      ADD A,(HL)
0000EA 01EA 77               7      LD  (HL),A
                                
0000EB 01EB 2AE803          16      LD  HL,(BASE)
0000EE 01EE 7C               4      LD  A,H
0000EF 01EF 016003          10      LD  BC,SHOW_ERROR+2
0000F2 01F2 09              11      ADD HL,BC
0000F3 01F3 86               7      ADD A,(HL)
0000F4 01F4 77               7      LD  (HL),A
                                
0000F5 01F5 2AE803          16      LD  HL,(BASE)
0000F8 01F8 7C               4      LD  A,H
0000F9 01F9 010803          10      LD  BC,CONST_+2
0000FC 01FC 09              11      ADD HL,BC
0000FD 01FD 86               7      ADD A,(HL)
0000FE 01FE 77               7      LD  (HL),A
                                
0000FF 01FF 2AE803          16      LD  HL,(BASE)
000102 0202 7C               4      LD  A,H
000103 0203 010B03          10      LD  BC,CONIN+2
000106 0206 09              11      ADD HL,BC
000107 0207 86               7      ADD A,(HL)
000108 0208 77               7      LD  (HL),A
                                
000109 0209 2AE803          16      LD  HL,(BASE)
00010C 020C 7C               4      LD  A,H
00010D 020D 010E03          10      LD  BC,CONOUT+2
000110 0210 09              11      ADD HL,BC
000111 0211 86               7      ADD A,(HL)
000112 0212 77               7      LD  (HL),A
                                
000113 0213 2AE803          16      LD  HL,(BASE)
000116 0216 7C               4      LD  A,H
000117 0217 011903          10      LD  BC,FCBPAT+2
00011A 021A 09              11      ADD HL,BC
00011B 021B 86               7      ADD A,(HL)
00011C 021C 77               7      LD  (HL),A
                                
00011D 021D 2AE803          16      LD  HL,(BASE)
000120 0220 111500          10      LD  DE,BDOS1
000123 0223 19              11      ADD HL,DE
000124 0224 EB               4      EX  DE,HL
                                
000125 0225 2AE803          16      LD  HL,(BASE)
000128 0228 2E06             7      LD  L,BDOS0
00012A 022A 25               4      DEC H
00012B 022B 25               4      DEC H
00012C 022C 220600          16      LD  (SYSTEM+1),HL
00012F 022F 36C3            10      LD  (HL),0C3H   ;JP
000131 0231 23               6      INC HL
000132 0232 73               7      LD  (HL),E
000133 0233 23               6      INC HL
000134 0234 72               7      LD  (HL),D
                                
000135 0235 0E19             7      LD  C,19H       ;(BDOS)_CURDRV カレントドライブ番号の獲得
000137 0237 CD7DF3          17      CALL    BDOS
00013A 023A 3C               4      INC A
                                
00013B 023B 2AE803          16      LD  HL,(BASE)
00013E 023E 017B02          10      LD  BC,FCBCMD
000141 0241 09              11      ADD HL,BC
000142 0242 77               7      LD  (HL),A
000143 0243 C640             7      ADD A,040H
000145 0245 326F03          13      LD  (V_SHELL),A
                                
000148 0248 3E28             7      LD  A,40
00014A 024A 32AEF3          13      LD  (LINL40),A
00014D 024D FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000151 0251 DD216C00        14      LD  IX,INITXT
000155 0255 CD1C00          17      CALL    CALSLT
000158 0258 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00015C 025C DD217800        14      LD  IX,SETTXT
000160 0260 CD1C00          17      CALL    CALSLT
                                
000163 0263 113003          10      LD  DE,TITLE
000166 0266 0E09             7      LD  C,9
000168 0268 CD7DF3          17      CALL    BDOS
00016B 026B 3AE603          13      LD  A,(ISDOS1)
00016E 026E 87               4      ADD A,A
00016F 026F 3854            12      JR  C,DOS1
000171 0271 1E32             7      LD  E,'2'
000173 0273 0E02             7      LD  C,2
000175 0275 CD7DF3          17      CALL    BDOS
000178 0278 3AE703          13      LD  A,(OS_EXT)
00017B 027B FE01             7      CP  1
00017D 027D 2008            12      JR  NZ,NONEXTOR
00017F 027F 113B03          10      LD  DE,TITLE_NEXTOR
000182 0282 0E09             7      LD  C,9
000184 0284 CD7DF3          17      CALL    BDOS
       0287                     NONEXTOR:
000187 0287 216903          10      LD  HL,N_SHELL
00018A 028A 116F03          10      LD  DE,V_SHELL
00018D 028D 0E6C             7      LD  C,06CH      ;_SENV 環境変数のセット
00018F 028F CD7DF3          17      CALL    BDOS
                                
000192 0292 3AC1FC          13      LD  A,(EXPTBL)  ;メインROMスロット
000195 0295 212B00          10      LD  HL,002BH    ;キャラクターセット・日時フォーマット・ビデオ信号の種別
000198 0298 CD0C00          17      CALL    RDSLT
00019B 029B 0F               4      RRCA
00019C 029C 0F               4      RRCA
00019D 029D 0F               4      RRCA
00019E 029E 0F               4      RRCA
00019F 029F E603             7      AND 3
0001A1 02A1 3D               4      DEC A
0001A2 02A2 118C03          10      LD  DE,V_DATE1
0001A5 02A5 2809            12      JR  Z,DATEOK
0001A7 02A7 3D               4      DEC A
0001A8 02A8 119503          10      LD  DE,V_DATE2
0001AB 02AB 2803            12      JR  Z,DATEOK
0001AD 02AD 118303          10      LD  DE,V_DATE0
       02B0                     DATEOK:
0001B0 02B0 217E03          10      LD  HL,N_DATE
0001B3 02B3 0E6C             7      LD  C,06CH      ;_SENV 環境変数のセット
0001B5 02B5 CD7DF3          17      CALL    BDOS
                                
0001B8 02B8 219E03          10      LD  HL,N_TIME
0001BB 02BB 11A303          10      LD  DE,V_TIME
0001BE 02BE 0E6C             7      LD  C,06CH      ;_SENV 環境変数のセット
0001C0 02C0 CD7DF3          17      CALL    BDOS
0001C3 02C3 180F            12      JR  DOS2
       02C5                     DOS1:
0001C5 02C5 3AE703          13      LD  A,(OS_EXT)
0001C8 02C8 FEFF             7      CP  0FFH
0001CA 02CA 2008            12      JR  NZ,NOTABLACUS
0001CC 02CC 114403          10      LD  DE,TITLE_TABLACUS
0001CF 02CF 0E09             7      LD  C,9
0001D1 02D1 CD7DF3          17      CALL    BDOS
       02D4                     NOTABLACUS:
       02D4                     DOS2:
0001D4 02D4 114F03          10      LD  DE,TITLE2
0001D7 02D7 0E09             7      LD  C,9
0001D9 02D9 CD7DF3          17      CALL    BDOS
                                
0001DC 02DC 212400          10      LD  HL,VER_BCD
0001DF 02DF 7C               4      LD  A,H
0001E0 02E0 CD1003          17      CALL    PRTHX1
0001E3 02E3 3E2E             7      LD  A,'.'
0001E5 02E5 CD1303          17      CALL    MSG_A
0001E8 02E8 7D               4      LD  A,L
0001E9 02E9 CD0703          17      CALL    PRTHX
                                
0001EC 02EC 115A03          10      LD  DE,TITLE3
0001EF 02EF 0E09             7      LD  C,9
0001F1 02F1 CD7DF3          17      CALL    BDOS
                                
0001F4 02F4 010900          10      LD  BC,9
0001F7 02F7 216003          10      LD  HL,AUTOEXEC
0001FA 02FA 118100          10      LD  DE,DTA1+1
0001FD 02FD EDB0                    LDIR
0001FF 02FF 3E09             7      LD  A,9
000201 0301 2A0100          16      LD  HL,(1)
000204 0304 2E10             7      LD  L,CBOOT & $FF
       0306                     JP_HL:
000206 0306 E9               4      JP  (HL)
                                
       0307                     PRTHX:
000207 0307 F5              11      PUSH    AF
000208 0308 07               4      RLCA
000209 0309 07               4      RLCA
00020A 030A 07               4      RLCA
00020B 030B 07               4      RLCA
00020C 030C CD1003          17      CALL    PRTHX1
00020F 030F F1              10      POP AF
       0310                     PRTHX1:
000210 0310 CD2603          17      CALL    ASC
       0313                     MSG_A:
000213 0313 F5              11      PUSH    AF
000214 0314 C5              11      PUSH    BC
000215 0315 D5              11      PUSH    DE
000216 0316 E5              11      PUSH    HL
000217 0317 DDE5            15      PUSH    IX
000219 0319 5F               4      LD  E,A
00021A 031A 0E02             7      LD  C,2
00021C 031C CD0500          17      CALL    SYSTEM
00021F 031F DDE1            14      POP IX
000221 0321 E1              10      POP HL
000222 0322 D1              10      POP DE
000223 0323 C1              10      POP BC
000224 0324 F1              10      POP AF
000225 0325 C9              10      RET
                                
       0326                     ASC:
000226 0326 E60F             7      AND 00FH
000228 0328 F630             7      OR  '0'
00022A 032A FE39             7      CP  '9'
00022C 032C D8              11      RET C
00022D 032D C607             7      ADD A,7
00022F 032F C9              10      RET
                                
       0330                     TITLE:
000230 0330 70736575646F2044        DB  "pseudo DOS$"
            4F5324              
       033B                     TITLE_NEXTOR:
00023B 033B 284E4558544F5229        DB  "(NEXTOR)$"
            24                  
       0344                     TITLE_TABLACUS:
000244 0344 285461626C616375        DB  "(Tablacus)$"
            732924              
       034F                     TITLE2:
00024F 034F 20666F72204D5358        DB  " for MSX v$"
            207624              
       035A                     TITLE3:
00025A 035A 2047616B7524            DB  " Gaku$"
       0360                     AUTOEXEC:
000260 0360 4155544F45584543        DB  "AUTOEXEC",0
            00                  
       0369                     N_SHELL:
000269 0369 5348454C4C00            DB  "SHELL",0
       036F                     V_SHELL:
00026F 036F 413A5C434F4D4D41        DB  "A:\\COMMAND.COM",0
            4E442E434F4D00      
       037E                     N_DATE:
00027E 037E 4441544500              DB  "DATE",0
       0383                     V_DATE0:
000283 0383 79792D6D6D2D6464        DB  "yy-mm-dd",0
            00                  
       038C                     V_DATE1:
00028C 038C 6D6D2D64642D7979        DB  "mm-dd-yy",0
            00                  
       0395                     V_DATE2:
000295 0395 64642D6D6D2D7979        DB  "dd-mm-yy",0
            00                  
       039E                     N_TIME:
00029E 039E 54494D4500              DB  "TIME",0
       03A3                     V_TIME:
0002A3 03A3 323400                  DB  "24",0
       03A6                     Z_TIME:
0002A6 03A6                         DS  64
       03E6                     ISDOS1:
0002E6 03E6 00                      DB  0
       03E7                     OS_EXT:
0002E7 03E7 00                      DB  0
       03E8                     BASE:
0002E8 03E8 0000                    DW  0
       03EA                     REAL:
0002EA 0004                         ORG 4,REAL-0100H
       0004                     MAIN:
0002EA 0004 0000                    DW  0
       0006                     BDOS0:
0002EC 0006 C31500          10      JP  BDOS1
       0008                     BDOS0_SWC   EQU $-1
       0009                     TERM:
0002EF 0009 78               4      LD  A,B
0002F0 000A 32C4F7          13      LD  (TRCFLG),A
0002F3 000D 210000          10      LD  HL,0
0002F6 0010 E5              11      PUSH    HL
0002F7 0011 2AAFF6          16      LD  HL,(DEFAB)
0002FA 0014 E9               4      JP  (HL)
       0015                     BDOS1:
0002FB 0015 0C               4      INC C
0002FC 0016 0D               4      DEC C
                                                ;BDOS0+013Hを0にするとバッチ停止されるため0が書き込みされる場合がある
0002FD 0017 CA0000          10      JP  Z,0     ;だから、ここのアドレスをBDOS0+011HもしくはBDOS0+012Hにする
000300 001A ED73B1F6        20      LD  (SAVSTK),SP
000304 001E 3263F6          13      LD  (SAVE_A),A
000307 0021 79               4      LD  A,C
000308 0022 FE62             7      CP  062H        ;_TERM エラーコードを返して終了
00030A 0024 28E3            12      JR  Z,TERM
00030C 0026 3AB2F6          13      LD  A,(SAVSTK+1)
00030F 0029 87               4      ADD A,A
000310 002A 3804            12      JR  C,BDOS_SPOK
000312 002C ED7BA7F6        20      LD  SP,(EXTSP)
       0030                     BDOS_SPOK:
000316 0030 79               4      LD  A,C
000317 0031 FE09             7      CP  9       ;_STROUT 文字列出力
000319 0033 CAE401          10      JP  Z,_SYS09
       0035                     SYS09_SWC   EQU     $-1
00031C 0036 FE63             7      CP  063H        ;_DEFAB アボート終了ルーチンの定義
00031E 0038 2004            12      JR  NZ,BDOS2
000320 003A ED53AFF6        20      LD  (DEFAB),DE
       003E                     BDOS2:
000324 003E FE1A             7      CP  01AH        ;_SETDTA DTAの設定
000326 0040 2004            12      JR  NZ,BDOS2_
000328 0042 ED53B5F6        20      LD  (_DTA),DE
       0046                     BDOS2_:
00032C 0046 32DFF4          13      LD  (SAVE_C),A
00032F 0049 FE0F             7      CP  00FH        ;_FOPEN ファイルオープン
000331 004B 3859            12      JR  C,SAVEFCB0
000333 004D FE12             7      CP  012H        ;_SNEXT ファイル検索 続き
000335 004F 2004            12      JR  NZ,NOBD12
000337 0051 ED5B07F3        20      LD  DE,(FCB11)
       0055                     NOBD12:
00033B 0055 FE18             7      CP  018H        ;_LOGIN ログインベクトルの獲得
00033D 0057 383A            12      JR  C,SAVEFCB36
00033F 0059 FE21             7      CP  021H        ;_RDRND ランダム読み出し
000341 005B 3849            12      JR  C,SAVEFCB0
000343 005D FE29             7      CP  028H+1      ;_WRZER ゼロ書き込みを伴うランダム書き込み+1
000345 005F 3832            12      JR  C,SAVEFCB36
000347 0061 FE31             7      CP  031H        ;_DPARM ディスクパラメータの獲得
000349 0063 282E            12      JR  Z,SAVEFCB36
00034B 0065 FE40             7      CP  040H        ;_FFIRST 最初のエントリ検索
00034D 0067 282A            12      JR  Z,SAVE_PATH
00034F 0069 FE42             7      CP  042H        ;_FNEW 新しいエントリの検索
000351 006B 2826            12      JR  Z,SAVE_PATH
000353 006D FE43             7      CP  043H        ;_OPEN ファイルハンドルのオープン
000355 006F 2822            12      JR  Z,SAVE_PATH
000357 0071 FE44             7      CP  044H        ;_CREATE ファイルハンドルの作成
000359 0073 281E            12      JR  Z,SAVE_PATH
00035B 0075 FE4C             7      CP  04CH        ;_HTEST ファイルハンドルの検査
00035D 0077 281A            12      JR  Z,SAVE_PATH
00035F 0079 FE4D             7      CP  04DH        ;_DELETE ファイル、サブディレクトリの削除
000361 007B 3829            12      JR  C,SAVEFCB0
000363 007D FE52             7      CP  051H+1      ;_FTIME ファイルの日付および時刻の獲得・設定
000365 007F 3812            12      JR  C,SAVE_PATH
000367 0081 FE59             7      CP  059H        ;_GETCD カレントディレクトリの獲得
000369 0083 3821            12      JR  C,SAVEFCB0
00036B 0085 FE5D             7      CP  05CH+1      ;_PFILE ファイル名の解析+1
00036D 0087 380A            12      JR  C,SAVE_PATH
00036F 0089 FE5E             7      CP  05EH        ;_WPATH パス文字列全体の獲得
000371 008B 2806            12      JR  Z,SAVE_PATH
000373 008D FE66             7      CP  066H        ;_EXPLAIN エラーコードの説明
000375 008F 2802            12      JR  Z,SAVE_PATH
000377 0091 1813            12      JR  SAVEFCB0
       0093                     SAVEFCB36:
       0093                     SAVE_PATH:
000379 0093 7A               4      LD  A,D
00037A 0094 FE3F             7      CP  03FH        ;ページ1にかぶる？
00037C 0096 380E            12      JR  C,SAVEFCB0
00037E 0098 FE80             7      CP  080H
000380 009A 300A            12      JR  NC,SAVEFCB0
000382 009C 3E24             7      LD  A,36
000384 009E CB71             8      BIT 6,C     ;DOS2のファンクションコール？
000386 00A0 2805            12      JR  Z,SAVEFCB1
000388 00A2 3E40             7      LD  A,64        ;DOS2CALLは64バイト設定する
00038A 00A4 1801            12      JR  SAVEFCB1
       00A6                     SAVEFCB0:
00038C 00A6 AF               4      XOR A
       00A7                     SAVEFCB1:
00038D 00A7 3262F6          13      LD  (DE_MEM_SIZE),A
000390 00AA B7               4      OR  A
000391 00AB 2815            12      JR  Z,BDOS3
000393 00AD C5              11      PUSH    BC
000394 00AE E5              11      PUSH    HL
000395 00AF ED53E0F4        20      LD  (SAVE_DE),DE
000399 00B3 4F               4      LD  C,A
00039A 00B4 0600             7      LD  B,0
00039C 00B6 211FF4          10      LD  HL,ALT_MEM
00039F 00B9 EB               4      EX  DE,HL
0003A0 00BA D5              11      PUSH    DE
0003A1 00BB EDB0                    LDIR
0003A3 00BD AF               4      XOR A
0003A4 00BE 12               7      LD  (DE),A
0003A5 00BF D1              10      POP DE
0003A6 00C0 E1              10      POP HL
0003A7 00C1 C1              10      POP BC
       00C2                     BDOS3:
0003A8 00C2 AF               4      XOR A
0003A9 00C3 32E3F4          13      LD  (SAVE_IX+1),A
0003AC 00C6 79               4      LD  A,C
0003AD 00C7 FE40             7      CP  040H        ;最初のエントリ検索
0003AF 00C9 3826            12      JR  C,BDOS3IX   ;次のエントリ検索
0003B1 00CB FE43             7      CP  042H+1      ;新しいエントリの検索
0003B3 00CD 3022            12      JR  NC,BDOS3IX
0003B5 00CF DD7C             9      LD  A,IXH
0003B7 00D1 FE3F             7      CP  03FH        ;ページ1にかぶる？
0003B9 00D3 381C            12      JR  C,BDOS3IX
0003BB 00D5 FE80             7      CP  080H        ;
0003BD 00D7 3018            12      JR  NC,BDOS3IX
0003BF 00D9 DD22E2F4        20      LD  (SAVE_IX),IX
0003C3 00DD C5              11      PUSH    BC
0003C4 00DE D5              11      PUSH    DE
0003C5 00DF E5              11      PUSH    HL
0003C6 00E0 DDE5            15      PUSH    IX
0003C8 00E2 E1              10      POP HL
0003C9 00E3 115FF4          10      LD  DE,ALT_MEM2
0003CC 00E6 014000          10      LD  BC,64
0003CF 00E9 D5              11      PUSH    DE
0003D0 00EA EDB0                    LDIR
0003D2 00EC DDE1            14      POP IX
0003D4 00EE E1              10      POP HL
0003D5 00EF D1              10      POP DE
0003D6 00F0 C1              10      POP BC
       00F1                     BDOS3IX:
0003D7 00F1 AF               4      XOR A
0003D8 00F2 32E5F4          13      LD  (SAVE_HL+1),A
0003DB 00F5 79               4      LD  A,C
0003DC 00F6 FE4E             7      CP  4EH     ;_RENAME ファイルあるいはサブディレクトリ名の変更
0003DE 00F8 281C            12      JR  Z,SAVE_HL1
0003E0 00FA FE4F             7      CP  4FH     ;_MOVE ファイルあるいはサブディレクトリの移動
0003E2 00FC 2818            12      JR  Z,SAVE_HL1
0003E4 00FE FE53             7      CP  53H     ;_HRENAME ファイルハンドルの名前の変更
0003E6 0100 2814            12      JR  Z,SAVE_HL1
0003E8 0102 FE54             7      CP  54H     ;_HMOVE ファイルハンドルの移動
0003EA 0104 2810            12      JR  Z,SAVE_HL1
0003EC 0106 FE5C             7      CP  05CH        ;_PFILE ファイル名の解析
0003EE 0108 280C            12      JR  Z,SAVE_HL1
0003F0 010A FE40             7      CP  040H        ;_FFIRST 最初のエントリ検索
0003F2 010C 2804            12      JR  Z,FIBCHECK
0003F4 010E FE42             7      CP  042H        ;_FNEW 新しいエントリ検索
0003F6 0110 201F            12      JR  NZ,BDOS3HL
       0112                     FIBCHECK:
0003F8 0112 1A               7      LD  A,(DE)
0003F9 0113 3C               4      INC A       ;DEがFIBならば0FFH
0003FA 0114 201B            12      JR  NZ,BDOS3HL
       0116                     SAVE_HL1:
0003FC 0116 7C               4      LD  A,H
0003FD 0117 FE3F             7      CP  03FH        ;ページ1にかぶる？
0003FF 0119 3816            12      JR  C,BDOS3HL
000401 011B FE80             7      CP  080H        ;
000403 011D 3012            12      JR  NC,BDOS3HL
000405 011F 22E4F4          16      LD  (SAVE_HL),HL
000408 0122 C5              11      PUSH    BC
000409 0123 D5              11      PUSH    DE
00040A 0124 014000          10      LD  BC,64
00040D 0127 119FF4          10      LD  DE,ALT_MEM3
000410 012A EDB0                    LDIR
000412 012C D1              10      POP DE
000413 012D C1              10      POP BC
000414 012E 219FF4          10      LD  HL,ALT_MEM3
       0131                     BDOS3HL:
000417 0131 79               4      LD  A,C
000418 0132 FE2F             7      CP  02FH
00041A 0134 CAF401          10      JP  Z,RDABS
       0136                     RDABS_SWC   EQU $-1
00041D 0137 FE30             7      CP  030H
00041F 0139 CA4002          10      JP  Z,WRABS
       013B                     WRABS_SWC   EQU $-1
       013C                     BDOS_EXEC:
000422 013C 3A63F6          13      LD  A,(SAVE_A)
000425 013F CD7DF3          17      CALL    BDOS
                                
000428 0142 F5              11      PUSH    AF
                                
000429 0143 3AE3F4          13      LD  A,(SAVE_IX+1)       ;最初のエントリ検索 + 次のエントリ検索
00042C 0146 B7               4      OR  A
00042D 0147 2815            12      JR  Z,BDOS4IX
00042F 0149 DD2AE2F4        20      LD  IX,(SAVE_IX)
000433 014D C5              11      PUSH    BC
000434 014E D5              11      PUSH    DE
000435 014F E5              11      PUSH    HL
000436 0150 DDE5            15      PUSH    IX
000438 0152 D1              10      POP DE
000439 0153 215FF4          10      LD  HL,ALT_MEM2
00043C 0156 014000          10      LD  BC,64
00043F 0159 EDB0                    LDIR
000441 015B E1              10      POP HL
000442 015C D1              10      POP DE
000443 015D C1              10      POP BC
       015E                     BDOS4IX:
000444 015E 3A62F6          13      LD  A,(DE_MEM_SIZE)
000447 0161 B7               4      OR  A
000448 0162 2812            12      JR  Z,BDOS4
00044A 0164 C5              11      PUSH    BC
00044B 0165 D5              11      PUSH    DE
00044C 0166 E5              11      PUSH    HL
00044D 0167 4F               4      LD  C,A
00044E 0168 0600             7      LD  B,0
000450 016A 211FF4          10      LD  HL,ALT_MEM
000453 016D ED5BE0F4        20      LD  DE,(SAVE_DE)
000457 0171 EDB0                    LDIR
000459 0173 E1              10      POP HL
00045A 0174 D1              10      POP DE
00045B 0175 C1              10      POP BC
       0176                     BDOS4:
00045C 0176 3AE5F4          13      LD  A,(SAVE_HL+1)
00045F 0179 B7               4      OR  A
000460 017A 2812            12      JR  Z,BDOS5
000462 017C C5              11      PUSH    BC
000463 017D D5              11      PUSH    DE
000464 017E E5              11      PUSH    HL
000465 017F 010B00          10      LD  BC,11
000468 0182 219FF4          10      LD  HL,ALT_MEM3
00046B 0185 ED5BE4F4        20      LD  DE,(SAVE_HL)
00046F 0189 EDB0                    LDIR
000471 018B E1              10      POP HL
000472 018C D1              10      POP DE
000473 018D C1              10      POP BC
       018E                     BDOS5:
000474 018E 3ADFF4          13      LD  A,(SAVE_C)
000477 0191 FE6F             7      CP  06FH        ;_DOSVER MSX-DOSのバージョン番号の獲得
000479 0193 2013            12      JR  NZ,BDOS7
00047B 0195 04               4      INC B
00047C 0196 05               4      DEC B
00047D 0197 2802            12      JR  Z,S6F_1
00047F 0199 59               4      LD  E,C     ;DOS2の場合
000480 019A 50               4      LD  D,B     ;MSXDOS2.SYSのバージョンをカーネルに合わす
       019B                     S6F_1:
000481 019B DD25            10      DEC IXH     ;NEXTOR判別
000483 019D 2807            12      JR  Z,NEXTOR
000485 019F DD21EDEC        14      LD  IX,0ECEDH   ;似非DOS判別用(INC IXがあるのでIXが0EDEDHになる)
000489 01A3 212400          10      LD  HL,VER_BCD  ;NEXTORじゃない場合はHLに似非DOSのバージョンが返る
       01A6                     NEXTOR:
00048C 01A6 DD24            10      INC IXH
       01A8                     BDOS7:
00048E 01A8 FE5B             7      CP  05BH        ;_PARSE パス名の解析
000490 01AA 2804            12      JR  Z,BDOS8
000492 01AC FE5E             7      CP  05EH        ;_WPATH パス文字列全体の獲得
000494 01AE 201E            12      JR  NZ,BDOS6
       01B0                     BDOS8:
000496 01B0 3A62F6          13      LD  A,(DE_MEM_SIZE)
000499 01B3 2819            12      JR  Z,BDOS6
00049B 01B5 C5              11      PUSH    BC
00049C 01B6 011FF4          10      LD  BC,ALT_MEM
00049F 01B9 ED42            15      SBC HL,BC       ;CF=0のハズ
0004A1 01BB ED4BE0F4        20      LD  BC,(SAVE_DE)
0004A5 01BF 09              11      ADD HL,BC
0004A6 01C0 EB               4      EX  DE,HL
0004A7 01C1 011FF4          10      LD  BC,ALT_MEM
0004AA 01C4 A7               4      AND A       ;念のためにCF=0にする
0004AB 01C5 ED42            15      SBC HL,BC
0004AD 01C7 ED4BE0F4        20      LD  BC,(SAVE_DE)
0004B1 01CB 09              11      ADD HL,BC
0004B2 01CC EB               4      EX  DE,HL
0004B3 01CD C1              10      POP BC
       01CE                     BDOS6:
0004B4 01CE F1              10      POP AF
       01CF                     S09X1:
0004B5 01CF ED7BB1F6        20      LD  SP,(SAVSTK)
0004B9 01D3 C9              10      RET
                                
       01D4                     CONST1:
0004BA 01D4 0E0B             7      LD  C,0BH
0004BC 01D6 C30500          10      JP  SYSTEM
       01D9                     CONIN1:
0004BF 01D9 0E07             7      LD  C,7
0004C1 01DB C30500          10      JP  SYSTEM
       01DE                     CONOUT1:
0004C4 01DE 59               4      LD  E,C
0004C5 01DF 0E02             7      LD  C,2
0004C7 01E1 C30500          10      JP  SYSTEM
                                
       01E4                     _SYS09:     ;_STROUT 文字列出力
0004CA 01E4 1A               7      LD  A,(DE)
0004CB 01E5 13               6      INC DE
0004CC 01E6 FE24             7      CP  '$'
0004CE 01E8 28E5            12      JR  Z,S09X1
0004D0 01EA D5              11      PUSH    DE
0004D1 01EB 0E02             7      LD  C,2
0004D3 01ED 5F               4      LD  E,A
0004D4 01EE CD7DF3          17      CALL    BDOS
0004D7 01F1 D1              10      POP DE
0004D8 01F2 18F0            12      JR  _SYS09
                                
       01F4                     RDABS:
0004DA 01F4 3AB6F6          13      LD  A,(_DTA+1)
0004DD 01F7 87               4      ADD A,A
0004DE 01F8 DA3C01          10      JP  C,BDOS_EXEC
       01FA                     BDOS_EXEC_SWC1  EQU $-1
                                
0004E1 01FB D5              11      PUSH    DE
0004E2 01FC E5              11      PUSH    HL
0004E3 01FD 1109FE          10      LD  DE,TERM-0200H
       01FF                     BUF512_SWC1 EQU $-1
0004E6 0200 0E1A             7      LD  C,01AH      ;_SETDTA
0004E8 0202 CD7DF3          17      CALL    BDOS
0004EB 0205 E1              10      POP HL
0004EC 0206 D1              10      POP DE
                                
0004ED 0207 ED4BB5F6        20      LD  BC,(_DTA)
       020B                     RDABS1:
0004F1 020B D5              11      PUSH    DE
0004F2 020C E5              11      PUSH    HL
0004F3 020D C5              11      PUSH    BC
0004F4 020E 2601             7      LD  H,1
0004F6 0210 0E2F             7      LD  C,02FH      ;_RDABS
0004F8 0212 CD7DF3          17      CALL    BDOS
0004FB 0215 E1              10      POP HL      ;<=転送先
0004FC 0216 FEFF             7      CP  0FFH
0004FE 0218 2814            12      JR  Z,RDABS_ERR
000500 021A EB               4      EX  DE,HL
000501 021B 2109FE          10      LD  HL,TERM-0200H
       021D                     BUF512_SWC2 EQU $-1
000504 021E 010002          10      LD  BC,512
000507 0221 EDB0                    LDIR
000509 0223 4B               4      LD  C,E
00050A 0224 42               4      LD  B,D
00050B 0225 E1              10      POP HL
00050C 0226 D1              10      POP DE
00050D 0227 13               6      INC DE
00050E 0228 25               4      DEC H
00050F 0229 20E0            12      JR  NZ,RDABS1
       022B                     WRABS_OK:
000511 022B AF               4      XOR A
       022C                     WRABS_ERR:
000512 022C D5              11      PUSH    DE
000513 022D E5              11      PUSH    HL
       022E                     RDABS_ERR:
000514 022E F5              11      PUSH    AF
000515 022F ED5BB5F6        20      LD  DE,(_DTA)
000519 0233 0E1A             7      LD  C,01AH      ;_SETDTA
00051B 0235 CD7DF3          17      CALL    BDOS
00051E 0238 F1              10      POP AF
00051F 0239 E1              10      POP HL
000520 023A D1              10      POP DE
000521 023B ED7BB1F6        20      LD  SP,(SAVSTK)
000525 023F C9              10      RET
                                
       0240                     WRABS:
000526 0240 3AB6F6          13      LD  A,(_DTA+1)
000529 0243 87               4      ADD A,A
00052A 0244 DA3C01          10      JP  C,BDOS_EXEC
       0246                     BDOS_EXEC_SWC2  EQU $-1
00052D 0247 D5              11      PUSH    DE
00052E 0248 E5              11      PUSH    HL
00052F 0249 1109FE          10      LD  DE,TERM-0200H
       024B                     BUF512_SWC3 EQU $-1
000532 024C 0E1A             7      LD  C,01AH      ;_SETDTA
000534 024E CD7DF3          17      CALL    BDOS
000537 0251 E1              10      POP HL
000538 0252 D1              10      POP DE
                                
000539 0253 ED4BB5F6        20      LD  BC,(_DTA)
       0257                     WRABS1:
00053D 0257 D5              11      PUSH    DE
00053E 0258 E5              11      PUSH    HL
00053F 0259 69               4      LD  L,C
000540 025A 60               4      LD  H,B
000541 025B 1109FE          10      LD  DE,TERM-0200H
       025D                     BUF512_SWC4 EQU $-1
000544 025E 010002          10      LD  BC,512
000547 0261 EDB0                    LDIR
000549 0263 E3              19      EX  (SP),HL
00054A 0264 D1              10      POP DE
                                
00054B 0265 D5              11      PUSH    DE
00054C 0266 E5              11      PUSH    HL
00054D 0267 2601             7      LD  H,1
00054F 0269 0E30             7      LD  C,030H      ;_WRABS
000551 026B CD7DF3          17      CALL    BDOS
000554 026E E1              10      POP HL
000555 026F D1              10      POP DE
000556 0270 C1              10      POP BC
000557 0271 FEFF             7      CP  0FFH
000559 0273 28B7            12      JR  Z,WRABS_ERR
00055B 0275 13               6      INC DE
00055C 0276 25               4      DEC H
00055D 0277 20DE            12      JR  NZ,WRABS1
00055F 0279 18B0            12      JR  WRABS_OK
                                
       027B                     FCBCMD:
000561 0661                         ORG $$+0100H    ;$DEPHASE
       0661                     AT_COMMAND1:
000561 027B                         ORG FCBCMD,AT_COMMAND1-0100H
000561 027B 00434F4D4D414E44        DB  0,"COMMAND COM",0,0,0,0
            20434F4D00000000    
                                
       028B                     AT:
000571 028B                         DS  0300H-37-AT
       02DB                     FCB_BAT:
0005C1 02DB                         DS  37          ;バッチファイル用のFCB
                                ;           下位1バイト0になるように
       0300                     BOOT:
0005E6 0300 C30F03          10      JP  WBOOT1
       0303                     WBOOT:
0005E9 0303 C30F03          10      JP  WBOOT1
       0306                     CONST_:         ;(BDOS)コンソール直接入力
0005EC 0306 C3D401          10      JP  CONST1
       0309                     CONIN:
0005EF 0309 C3D901          10      JP  CONIN1
       030C                     CONOUT:
0005F2 030C C3DE01          10      JP  CONOUT1
                                
       030F                     WBOOT1:
0005F5 030F AF               4      XOR A
       0310                     CBOOT:
0005F6 0310 3263F6          13      LD  (SAVE_A),A
0005F9 0313 ED7B0600        20      LD  SP,(SYSTEM+1)
       0317                     RELOAD:
0005FD 0317 217B02          10  FCBPAT: LD  HL,FCBCMD
       031A                     DOS1RELOAD:
       0700                     AT_DOS1RELOAD   EQU $$+0100H
000600 031A 115C00          10      LD  DE,FCB1
000603 031D 011000          10      LD  BC,16
000606 0320 EDB0                    LDIR
                                
000608 0322 115C00          10      LD  DE,FCB1
00060B 0325 0E0F             7      LD  C,00FH      ;(BDOS)_FOPEN ファイルオープン
00060D 0327 CD7DF3          17      CALL    BDOS
000610 032A B7               4      OR  A
000611 032B 2031            12      JR  NZ,SHOW_ERROR
000613 032D 210000          10      LD  HL,0
000616 0330 227D00          16      LD  (FCB1+33),HL
000619 0333 227F00          16      LD  (FCB1+35),HL
00061C 0336 2C               4      INC L
00061D 0337 226A00          16      LD  (FCB1+14),HL
                                
000620 033A 110001          10      LD  DE,00100H
000623 033D 0E1A             7      LD  C,01AH      ;(BDOS)DTAの設定
000625 033F CD7DF3          17      CALL    BDOS
                                
000628 0342 115C00          10      LD  DE,FCB1
00062B 0345 2100BF          10      LD  HL,0BF00H
00062E 0348 0E27             7      LD  C,027H      ;(BDOS)ランダムブロックリード
000630 034A CD7DF3          17      CALL    BDOS
       034D                     READOK:
000633 034D 7C               4      LD  A,H
000634 034E B5               4      OR  L
000635 034F 3A63F6          13      LD  A,(SAVE_A)
000638 0352 328000          13      LD  (DTA1),A
00063B 0355 210000          10      LD  HL,0
00063E 0358 22AFF6          16      LD  (DEFAB),HL  ;DEFABの初期化
000641 035B C20001          10      JP  NZ,0100H
       035E                     SHOW_ERROR:
000644 035E 116F03          10      LD  DE,ERROR
000647 0361 0E09             7      LD  C,9
000649 0363 CD7DF3          17      CALL    BDOS
00064C 0366 0E08             7      LD  C,8
00064E 0368 CD7DF3          17      CALL    BDOS
000651 036B AF               4      XOR A
000652 036C 24               4      INC H
000653 036D 18A8            12      JR  RELOAD
                                
       036F                     ERROR:
000655 036F 0D0A496E73657274        DB  00DH,00AH,"Insert System disk$"
            2053797374656D20    
            6469736B24          
                                
       0384                     MAIN_END:
00066A 076A                         ORG $$+0100H    ;$DEPHASE
       076A                     AT_DOS2RELOAD:
00066A 031A                         ORG DOS1RELOAD,AT_DOS2RELOAD-0100H
       031A                     DOS2RELOAD:
00066A 031A 23               6      INC HL      ;HLは"SHELL"のポインタ
00066B 031B 111FF4          10      LD  DE,ALT_MEM
00066E 031E 0640             7      LD  B,64
000670 0320 0E6B             7      LD  C,06BH      ;_GENV 環境変数の獲得
000672 0322 CD7DF3          17      CALL    BDOS
000675 0325 111FF4          10      LD  DE,ALT_MEM
000678 0328 AF               4      XOR A
000679 0329 0E43             7      LD  C,043H      ;_OPEN ファイルハンドルのオープン
00067B 032B CD7DF3          17      CALL    BDOS
00067E 032E B7               4      OR  A
00067F 032F 202D            12      JR  NZ,SHOW_ERROR
000681 0331 C5              11      PUSH    BC
000682 0332 110001          10      LD  DE,00100H
000685 0335 2100BF          10      LD  HL,0BF00H
000688 0338 0E48             7      LD  C,48H       ;_READ ファイルハンドルからの読み出し
00068A 033A CD7DF3          17      CALL    BDOS
00068D 033D C1              10      POP BC
00068E 033E B7               4      OR  A
00068F 033F 201D            12      JR  NZ,SHOW_ERROR
000691 0341 E5              11      PUSH    HL
000692 0342 0E45             7      LD  C,45H       ;_CLOSE ファイルハンドルのクローズ
000694 0344 CD7DF3          17      CALL    BDOS
000697 0347 E1              10      POP HL
000698 0348 1803            12      JR  READOK
       034A                     DOS2RELOAD_:
00069A 079A                         ORG $$+0100H    ;$DEPHASE
[EOF:DOS.ASM:UTF_8]
